syntax = "proto3";

package session;

import "github.com/gogo/protobuf/gogoproto/gogo.proto";

import "google/protobuf/timestamp.proto";

import "github.com/havoc-io/mutagen/rsync/rsync.proto";

enum SessionVersion {
    Unknown = 0;
    Version1 = 1;
}

message Session {
    string identifier = 1;
    SessionVersion version = 2;
    google.protobuf.Timestamp creationTime = 3 [(gogoproto.stdtime) = true];
    uint32 creatingVersionMajor = 4;
    uint32 creatingVersionMinor = 5;
    uint32 creatingVersionPatch = 6;
    string alpha = 7;
    string beta = 8;
    bool paused = 9;
    string error = 10;
}

enum ControllerAction {
    Halted = 0;
    ProbingAlpha = 1;
    ProbingBeta = 2;
    Watching = 3;
    SnapshottingAlpha = 4;
    SnapshottingBeta = 5;
    Reconciling = 6;
    StagingAlphaToBeta = 7;
    StagingBetaToAlpha = 8;
    ApplyingAlpha = 9;
    ApplyingBeta = 10;
    Saving = 11;
}

message SynchronizationState {
    ControllerAction action = 1;
    string message = 2;
}

message SessionState {
    Session session = 1;
    SynchronizationState synchronizationState = 2;
}

message PromptRequest {
    string prompt = 1;
    string context = 2;
}

message PromptResponse {
    string response = 1;
}

message StartRequest {
    string alpha = 1;
    string beta = 2;
    PromptResponse response = 3;
}

message StartResponse {
    PromptRequest prompt = 1;
}

message ListRequest {
    bool streaming = 1;
}

message ListResponse {
    repeated SessionState sessions = 1;
}

message PauseRequest {
    string session = 1;
}

message PauseResponse {}

// TODO: Add ResolveRequest and ResolveResponse once sync data structures exist.

message ResumeRequest {
    string session = 1;
    PromptResponse response = 2;
}

message ResumeResponse {
    PromptRequest prompt = 1;
}

message StopRequest {
    string session = 1;
}

message StopResponse {}

service Manager {
    rpc Start(stream StartRequest) returns (stream StartResponse) {}
    rpc List(ListRequest) returns (stream ListResponse) {}
    rpc Pause(PauseRequest) returns (PauseResponse) {}
    // TODO: Add Resolve.
    rpc Resume(stream ResumeRequest) returns (stream ResumeResponse) {}
    rpc Stop(StopRequest) returns (StopResponse) {}
}

message ProbeRequest {}

message ProbeResponse {
    bool decomposesUnicode = 1;
    bool preservesExecutability = 2;
}

message WatchRequest {}

message WatchResponse {}

message StageRequest {
    string path = 1;
    bool executable = 2;
    bytes digest = 3;
    rsync.Operation operation = 4;
}

message StageResponse {
    bool alreadyStaged = 1;
    repeated rsync.BlockHash baseSignature = 2;
}

message TransmitRequest {
    string path = 1;
    repeated rsync.BlockHash baseSignature = 2;
}

message TransmitResponse {
    rsync.Operation operation = 1;
}

message SnapshotRequest {
    repeated rsync.BlockHash baseSignature = 1;
}

message SnapshotResponse {
    repeated rsync.Operation operations = 1;
}

// TODO: Add ApplyRequest and ApplyResponse once sync data structures exist.

service Endpoint {
    rpc Probe(ProbeRequest) returns (ProbeResponse) {}
    rpc Watch(WatchRequest) returns (stream WatchResponse) {}
    rpc Stage(stream StageRequest) returns (stream StageResponse) {}
    rpc Transmit(TransmitRequest) returns (stream TransmitResponse) {}
    rpc Snapshot(SnapshotRequest) returns (SnapshotResponse) {}
    // TODO: Add Apply.
}
